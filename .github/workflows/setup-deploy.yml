name: Voice Over Artist Landing Page - Auto Deploy

# This workflow automatically deploys the Voice Over Artist landing page
# Built with Vite + React + Tailwind CSS
# Deploys to EC2 server with PM2, Nginx, and SSL

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          cd ci-cd-basics
          npm ci

      - name: Build Application
        run: |
          cd ci-cd-basics
          npm run build

      - name: Verify Build Output
        run: |
          cd ci-cd-basics
          ls -la dist/
          test -f dist/index.html || (echo "Build failed: index.html not found" && exit 1)

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Full Frontend Server Setup & Deploy
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<EOF

          APP_DIR=voiceover-landing

          # ===== SYSTEM UPDATE =====
          sudo apt update -y && sudo apt upgrade -y

          # ===== CORE TOOLS =====
          sudo apt install -y git nginx curl certbot python3-certbot-nginx

          # ===== NODE =====
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt install -y nodejs

          # ===== PM2 =====
          sudo npm install -g pm2
          pm2 startup systemd -u ${{ secrets.EC2_USER }} --hp /home/${{ secrets.EC2_USER }}

          # ===== CLONE SAME REPO =====
          if [ ! -d "\$APP_DIR" ]; then
            git clone git@github.com:${{ github.repository }} \$APP_DIR
          fi

          cd \$APP_DIR
          git pull origin main

          # ===== BUILD VITE =====
          cd ci-cd-basics
          npm install
          npm run build

          # ===== SERVE WITH PM2 =====
          pm2 delete ${{ secrets.PM2_NAME }} || true
          pm2 serve ci-cd-basics/dist ${{ secrets.PM2_PORT }} --name ${{ secrets.PM2_NAME }} --spa
          pm2 save

          # ===== NGINX CONFIG =====
          sudo tee /etc/nginx/sites-available/voiceover > /dev/null <<EOT
          server {
              listen 80;
              server_name ${{ secrets.DOMAIN }};

              location / {
                  proxy_pass http://localhost:${{ secrets.PM2_PORT }};
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
              }
          }
          EOT

          sudo ln -sf /etc/nginx/sites-available/voiceover /etc/nginx/sites-enabled/
          sudo nginx -t
          sudo systemctl reload nginx

          # ===== SSL =====
          sudo certbot --nginx -d ${{ secrets.DOMAIN }} \
            --non-interactive --agree-tos -m ${{ secrets.EMAIL }}

          EOF
